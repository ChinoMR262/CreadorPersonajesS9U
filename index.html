<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>S9U â€” Helios Engine Data v8</title>

  <!-- Google Fonts: Orbitron (Sci-Fi) & Rajdhani (Tech) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Rajdhani:wght@300;400;500;600;700&display=swap"
    rel="stylesheet">

  <!-- Comentario: Metadatos de seguridad y carga inicial. -->
  <!-- Seguridad: CSP y Guardia de Autenticación -->
  <meta http-equiv="Content-Security-Policy"
    content="default-src 'self' https:; script-src 'self' 'unsafe-inline' https:; style-src 'self' 'unsafe-inline' https:; font-src 'self' https: data:; img-src 'self' data: https: blob:;">
  <script>
    (async function () {
      const AUTH_TOKEN = 's9u_auth_token_v8_secure';
      const isFile = (location.protocol === 'file:');

      // Comentario: Chequeo de mantenimiento antes de renderizar la app.
      // 1. Verificar Modo Mantenimiento (Archivo y LocalStorage)
      // We use synchronous XHR for the file check to block immediate rendering if needed, 
      // though async is better practice, for this startup script simple fetch is okay but we need to await it.
      // Since we can't top-level await in this IIFE structure easily without making it async, we'll use a promise chain or sync XHR.
      // For simplicity and blocking behavior, sync XHR is actually safer to prevent app flash.

      let maintenanceFileActive = false;
      if (!isFile) {
        try {
          const response = await fetch('maintenance_mode.json?t=' + new Date().getTime());
          if (response.ok) {
            const data = await response.json();
            if (data.active) maintenanceFileActive = true;
          }
        } catch (e) { /* file not found or parse error */ }
      }

      // 1. Verificar Modo Mantenimiento (Solo Archivo - Única Fuente de Verdad)
      const maintenanceMode = maintenanceFileActive;

      if (maintenanceMode) {
        // Comentario: Mensaje visual de mantenimiento (pantalla negra + luz verde).
        // Mostrar Indicador de Luz Verde
        document.write(`
                    <style>
                        #green-light-overlay {
                            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                            background: #000; z-index: 99999; display: flex;
                            justify-content: center; align-items: center; flex-direction: column;
                        }
                        .green-light {
                            width: 20px; height: 20px; border-radius: 50%;
                            background: #0f0; box-shadow: 0 0 20px #0f0, 0 0 40px #0f0;
                            animation: blink 0.5s infinite alternate;
                        }
                        .maintenance-text {
                            margin-top: 20px; color: #0f0; font-family: monospace; letter-spacing: 2px;
                        }
                        @keyframes blink { from { opacity: 0.3; } to { opacity: 1; } }
                    </style>
                    <div id="green-light-overlay">
                        <div class="green-light"></div>
                        <div class="maintenance-text">SYSTEM MAINTENANCE DETECTED</div>
                    </div>
                `);

        // Redireccionar después de un breve retraso
        setTimeout(() => {
          window.location.href = 'maintenance.html';
        }, 1500);

        // Comentario: Detiene el resto de scripts si hay mantenimiento.
        // Detener ejecución posterior
        window.stop();
      }

      // 2. Verificar Autenticación (Solo si no está en mantenimiento)
      else if (!isFile && localStorage.getItem('s9u_auth') !== AUTH_TOKEN) {
        window.location.href = 'SeguridadTotal/Seguridad.html';
      }
    })();
  </script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;400;500;600;700&family=Share+Tech+Mono&family=Exo+2:wght@400;600;700&family=Inter:wght@400;500;600&display=swap"
    rel="stylesheet">
  <link
    href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Great+Vibes&family=Playfair+Display:ital,wght@0,400;0,700;1,400&display=swap"
    rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="css/styles.css">
  <link rel="stylesheet" href="css/splash.css">
  <!-- Comentario: Estilos del modulo MBTI (si se activa en el futuro). -->
  <link rel="stylesheet" href="css/PersonalidadMBTI.css">
</head>

<body>
  <!-- Comentario: Contenedores para inyectar parciales (nav, header, main). -->
  <!-- Contenedores de Inyección de Parciales -->
  <div id="nav-container"></div>
  <div class="content" style="max-width:1280px;margin:0 auto;padding:24px 16px">
    <div id="header-container"></div>
    <div id="main-container"></div>
  </div>

  <!-- INICIO DE PLANTILLAS EMBEBIDAS -->
  <!-- TEMPLATES EMBEBIDOS PARA MODO FILE:// -->
  <template id="tpl-nav">
    <!-- BOTÓN FLOTANTE (GEAR) -->
    <!-- Comentario: Botones flotantes (configuración y subir). -->
    <button class="gear-btn" onclick="toggleSettings()"><i class="fas fa-cog"></i></button>
    <button class="scroll-top-btn" id="scrollTopBtn" onclick="scrollToTop()" aria-label="Volver arriba"
      title="Volver arriba"><i class="fas fa-arrow-up"></i></button>
    <!-- Comentario: Panel de configuración con opciones de UI. -->
    <div class="settings-panel" id="settingsPanel">
      <h3><i class="fas fa-sliders-h"></i> &nbsp;CONFIGURACIÓN</h3>
      <!-- Comentario: Tamaño de fuente del sitio. -->
      <div class="settings-row"><label>Tamaño de texto</label>
        <div class="size-btns">
          <button class="size-btn" onclick="setFontSize(12,'S')" id="sizeS">S</button>
          <button class="size-btn active" onclick="setFontSize(14,'M')" id="sizeM">M</button>
          <button class="size-btn" onclick="setFontSize(16,'L')" id="sizeL">L</button>
          <button class="size-btn" onclick="setFontSize(18,'XL')" id="sizeXL">XL</button>
        </div>
      </div>
      <!-- Comentario: Selector de familia tipográfica. -->
      <div class="settings-row"><label>Familia de fuente</label>
        <select class="font-select" id="fontFamilySelect" onchange="applyFont()">
          <option value="Rajdhani">Rajdhani</option>
          <option value="Exo 2">Exo 2</option>
          <option value="Inter">Inter</option>
          <option value="Share Tech Mono">Share Tech Mono</option>
          <option value="Orbitron">Orbitron</option>
        </select>
      </div>
      <!-- Comentario: Activar o desactivar efectos de sonido. -->
      <div class="settings-row"><label>Sonidos</label>
        <div class="settings-toggle">
          <div class="mute-toggle on" id="muteToggle" role="switch" aria-checked="true" onclick="toggleMute()"></div>
          <span class="settings-hint" id="soundStatus">Activo</span>
        </div>
      </div>
      <!-- Comentario: Activar análisis con Gemini si hay clave. -->
      <div class="settings-row"><label>IA Gemini</label>
        <div class="settings-toggle">
          <div class="mute-toggle on" id="geminiToggle" role="switch" aria-checked="true" onclick="toggleGemini()"></div>
          <span class="settings-hint" id="geminiStatus">IA activa</span>
        </div>
      </div>
      <!-- Comentario: Campo para pegar la API Key (opcional). -->
      <div class="settings-row"
        style="flex-direction:column;align-items:stretch;gap:8px;margin-top:-4px;padding-bottom:12px;border-bottom:1px solid rgba(255,255,255,0.05)">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <label style="font-size:11px;opacity:0.7">Clave API (Opcional)</label>
          <span id="apiKeyStatus" style="font-size:10px"></span>
        </div>
        <input type="password" id="geminiKeyInput" placeholder="Pegar API Key de Google Gemini..."
          style="background:rgba(0,0,0,0.3);border:1px solid rgba(255,255,255,0.1);color:#fff;padding:6px;font-family:'Share Tech Mono';font-size:11px;border-radius:4px;outline:none;width:100%"
          oninput="onKeyInput()">
      </div>
      <!-- Comentario: Control global de animaciones. -->
      <div class="settings-row"><label>Animaciones</label>
        <div class="settings-toggle">
          <div class="mute-toggle on" id="animsToggle" role="switch" aria-checked="true" onclick="toggleAnims()"></div>
          <span class="settings-hint" id="animsStatus">Animaciones activas</span>
        </div>
      </div>
      <!-- Comentario: Toggle de tema claro/oscuro. -->
      <div class="settings-row"><label>Modo Claro</label>
        <div class="settings-toggle">
          <div class="mute-toggle" id="themeToggle" role="switch" aria-checked="false" onclick="toggleTheme()"></div>
          <span class="settings-hint" id="themeStatus">Oscuro</span>
        </div>
      </div>
      <!-- Comentario: Guardado automático de progreso. -->
      <div class="settings-row"><label>Guardado Automático</label>
        <div class="settings-toggle">
          <div class="mute-toggle" id="autosaveToggle" role="switch" aria-checked="false" onclick="toggleAutosave()"></div>
          <span class="settings-hint" id="autosaveStatus">Manual</span>
        </div>
      </div>
    </div>

  </template>
  <template id="tpl-header">
    <!-- SPLASH SCREEN -->
    <!-- Comentario: Pantalla de bienvenida con animaciones y créditos. -->
    <div class="splash-screen" id="splashScreen">
      <div class="splash-stars"></div>
      <div class="splash-content">
        <div class="splash-line sl-1">SERES DEL</div>
        <div class="splash-line sl-2">NOVENO</div>
        <div class="splash-line sl-3">UNIVERSO</div>
        <div class="splash-sign">Jonathan Gabriel Nieto</div>
      </div>
      <!-- Comentario: Texto legal visible en la pantalla de inicio. -->
      <div class="splash-copy">
        Copyright © 2026 Seres Del Noveno Universo. Todos los derechos reservados.
      </div>
    </div>
    <!-- ============================================================
     CAPAS VISUALES (FONDO)
     - bg-layer: luces/gradientes
     - cyber-grid: rejilla
     - particle: partículas animadas
     ============================================================ -->
    <!-- Comentario: Capas visuales de fondo. -->
    <div class="bg-layer"></div>
    <div class="cyber-grid"></div>
    <div class="particle p1"></div>
    <div class="particle p2"></div>
    <div class="particle p3"></div>
    <div class="particle p4"></div>
    <div class="particle p5"></div>
    <div class="particle p6"></div>

    <!-- Comentario: Encabezado principal con título y estado. -->
    <header class="text-center mb-8">
      <h1 class="main-title mb-2" id="headerTitle" style="min-height:1.2em"></h1>
      <!-- Comentario: Subtítulo con contraste mejorado vía CSS. -->
      <p id="headerSubtitle"
        style="font-family:'Share Tech Mono';letter-spacing:2px;margin-bottom:16px;min-height:1.2em">
      </p>
      <div style="display:inline-flex;align-items:center;gap:10px;padding:8px 18px" class="gc">
        <div class="status-dot"></div>
        <!-- Comentario: Estado con tamaño/color definidos en CSS para mayor legibilidad. -->
        <span id="headerStatus"
          style="font-family:'Orbitron';font-weight:700;letter-spacing:2px;min-height:1.2em"></span>
      </div>
      <div class="scan-wrap">
        <div class="scan-bar"></div>
      </div>
    </header>

  </template>
  <template id="tpl-main">
    <!-- ============================================================
     TERMINAL (UI)
     - Bloque visual de arranque/estado con estética de terminal.
     - No afecta la lógica de Helios: es feedback visual del sistema.
     - Útil para indicar que el motor está activo y listo.
     ============================================================ -->
    <!-- TERMINAL -->
    <div class="gc mb-8" style="padding:0;overflow:hidden">
      <div
        style="background:rgba(59,130,246,.08);padding:8px 16px;display:flex;align-items:center;gap:8px;border-bottom:1px solid rgba(59,130,246,.15)">
        <div style="width:10px;height:10px;border-radius:50%;background:#ef4444"></div>
        <div style="width:10px;height:10px;border-radius:50%;background:#f59e0b"></div>
        <div style="width:10px;height:10px;border-radius:50%;background:#10b981"></div>
        <span id="terminalHeader"
          style="font-family:'Share Tech Mono';font-size:10px;color:rgba(255,255,255,.3);margin-left:8px;min-height:1.2em"></span>
        <div id="utcClock" class="terminal-clock">--:--:-- UTC</div>
      </div>
      <div class="terminal" id="terminal"></div>
    </div>

    <div style="display:grid;gap:24px" id="mainGrid">
      <div id="formCol" style="display:flex;flex-direction:column;gap:24px">

        <!-- Comentario: Plantilla principal del contenido (formularios, secciones y paneles). -->
        <!-- ============================================================
     IDENTIDAD GENERAL
     - Campos centrales del personaje (nombre, rol, universo, raza, etc.)
     - Incluye presets editables y validación para habilitar Helios.
     - Cambiar el rol impacta: modo villano, catálogos, test y chat.
     ============================================================ -->
        <!-- IDENTIDAD -->
        <div class="gc" style="padding:24px">
          <div class="sec-title"><i class="fas fa-id-card-alt"></i> IDENTIDAD GENERAL</div>
          <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px">
            <input type="text" id="nombre" placeholder="Nombre Completo" class="inp" oninput="checkValidation()"
              aria-label="Nombre Completo">
            <input type="text" id="alias" list="aliasSugerencias" placeholder="Alias / Títulos" class="inp"
              aria-label="Alias o Títulos">
            <select id="genero" class="inp" aria-label="Género">
              <option value="">— Género —</option>
              <option>Hombre</option>
              <option>Mujer</option>
            </select>
            <select id="rolNarrativo" class="inp" aria-label="Rol Narrativo">
              <option value="">— Rol narrativo —</option>
              <option>Héroe</option>
              <option>AntiHéroe</option>
              <option>Villano</option>
              <option>Neutral</option>
            </select>
            <input type="text" id="apodos" list="apodosSugerencias" placeholder="Apodos" class="inp"
              aria-label="Apodos">
            <input type="text" id="tituloEspiritual" list="titulosEspirituales"
              placeholder="Título espiritual (opcional)" class="inp" aria-label="Título Espiritual">
            <datalist id="aliasSugerencias">
              <option value="La Heredera del Abismo"></option>
              <option value="El/La Vigía del Velo"></option>
              <option value="Sello de Posidonia"></option>
              <option value="Ecos de Siul"></option>
              <option value="Arquitecto/a de Corrientes"></option>
              <option value="La Voz del Mar"></option>
            </datalist>
            <datalist id="apodosSugerencias">
              <option value="La Nacarada"></option>
              <option value="Ojos de Galaxia"></option>
              <option value="Corriente Viva"></option>
              <option value="Sombra Coralina"></option>
              <option value="Luz Abisal"></option>
            </datalist>
            <datalist id="titulosEspirituales">
              <option value="Hija de la Corriente Divina"></option>
              <option value="Portador/a del Equilibrio"></option>
              <option value="Eco de la Luz Abisal"></option>
              <option value="Sello Viviente de Helios"></option>
              <option value="Herald@ del Vínculo Totémico"></option>
            </datalist>
            <input type="text" id="eslogan" list="esloganSugerencias" placeholder="Eslogan del personaje" class="inp"
              style="grid-column:1/-1" aria-label="Eslogan del personaje">
            <datalist id="esloganSugerencias">
              <option value="Donde el agua canta, la verdad despierta."></option>
              <option value="La luz no salva: revela."></option>
              <option value="Mi voluntad es corriente. Mi destino, océano."></option>
              <option value="El abismo no devora: transforma."></option>
              <option value="Yo decido qué permanece."></option>
            </datalist>
            <select id="universo" class="inp" onchange="onUniversoChange()" aria-label="Universo de Origen">
              <option value="">— Universo de Origen —</option>
            </select>
            <select id="planeta" class="inp" onchange="checkValidation()" aria-label="Planeta Natal">
              <option value="">— Planeta Natal —</option>
            </select>
            <select id="raza" class="inp" onchange="checkValidation()" aria-label="Raza o Linaje">
              <option value="">— Raza / Linaje —</option>
            </select>
            <select id="raza2" class="inp" aria-label="Segunda Raza">
              <option value="">— Raza (segunda / mixta) —</option>
            </select>
            <select id="signoZodiaco" class="inp" aria-label="Signo Zodiacal">
              <option value="">— Signo Zodiacal —</option>
            </select>
            <input type="text" id="edadReal" placeholder="Edad real" class="inp" aria-label="Edad Real">
            <input type="text" id="edadAparente" placeholder="Edad aparente" class="inp" aria-label="Edad Aparente">
            <input type="text" id="altura" placeholder="Altura (m)" class="inp" aria-label="Altura">
            <select id="condicion" class="inp" aria-label="Condición Existencial">
              <option value="">— Condición Existencial —</option>
              <option>Humano</option>
              <option>Híbrido</option>
              <option>Divino</option>
              <option>Ángel</option>
              <option>Demonio</option>
              <option>Infernal</option>
              <option>Maldito</option>
              <option>Entidad</option>
              <option>Entidad Abisal</option>
              <option>Espíritu</option>
              <option>Espectro</option>
              <option>Reencarnado</option>
              <option>Resucitado</option>
              <option>Vampírico</option>
              <option>No-muerto</option>
              <option>Artificial</option>
              <option>Desconocido</option>
            </select>
            <select id="rango" class="inp" style="grid-column:1/-1" onchange="checkValidation()"
              aria-label="Rango Jerárquico">
              <option value="">— Rango Jerárquico —</option>
            </select>
          </div>
          <div id="villainPanel"
            style="display:none;margin-top:14px;padding-top:14px;border-top:1px solid rgba(239,68,68,.18)">
            <div style="font-family:'Orbitron';font-size:10px;letter-spacing:1.5px;color:#fca5a5;margin-bottom:10px"><i
                class="fas fa-skull"></i> PERFIL DE VILLANO</div>
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px">
              <select id="villainMotivacion" class="inp villain-select"
                onchange="handleVillainSelectChange('motivacion')" aria-label="Motivación Villano">
                <option value="">— Motivación —</option>
              </select>
              <select id="villainObjetivo" class="inp villain-select" onchange="handleVillainSelectChange('objetivo')"
                aria-label="Objetivo Villano">
                <option value="">— Objetivo final —</option>
              </select>
              <select id="villainMetodos" class="inp villain-select" onchange="handleVillainSelectChange('metodos')"
                aria-label="Métodos Villano">
                <option value="">— Métodos —</option>
              </select>
              <select id="villainDebilidad" class="inp villain-select" onchange="handleVillainSelectChange('debilidad')"
                aria-label="Debilidad Villano">
                <option value="">— Debilidad / Falla —</option>
              </select>
              <select id="villainCrueldad" class="inp" aria-label="Nivel de Crueldad">
                <option value="">— Nivel de crueldad —</option>
                <option>Baja</option>
                <option>Media</option>
                <option>Alta</option>
                <option>Implacable</option>
              </select>
            </div>
          </div>
        </div>

        <div class="gc" style="padding:24px">
          <!--
    PREGUNTAS CLAVE (PERSONALIDAD)
    - Reemplaza la antigua sección "Forma de saludar".
    - Son preguntas morales/decisionales; alimentan Helios.
    - La conclusión se genera localmente en tiempo real (ver generarConclusionMoral()).
  -->
          <div class="sec-title" id="moralTitle"><i class="fas fa-comments-alt"></i> PREGUNTAS CLAVE PARA DEFINIR SU
            PERSONALIDAD</div>
          <p class="note-text" id="moralDesc" style="margin-bottom:14px">Responde y Helios generará una
            conclusión breve del perfil moral (editable por tus respuestas).</p>
          <div id="saludosContainer"></div>
          <div class="counter-badge" id="moralSummary" style="margin-top:10px;display:inline-block">Conclusión del
            perfil moral: —</div>
        </div>

        <div class="gc" style="padding:24px">
          <div class="sec-title"><i class="fas fa-tshirt"></i> VESTIMENTA DEL PERSONAJE</div>
          <p class="note-text" style="margin-bottom:14px">Define la estética del personaje por partes. Abre una
            sección y selecciona una opción.</p>
          <div id="vestimentaContainer" style="display:flex;flex-direction:column;gap:10px"></div>
        </div>

        <div class="gc" style="padding:24px">
          <div class="sec-title"><i class="fas fa-eye"></i> APARIENCIA</div>
          <p class="note-text" style="margin-bottom:14px">Describe la presencia física y estética del personaje
            con detalle (esto alimenta Helios y la historia).</p>
          <div id="aparienciaContainer" style="display:flex;flex-direction:column;gap:10px"></div>
          <textarea id="apExtra" class="inp" style="margin-top:12px;height:90px;resize:none"
            placeholder="Detalles extra de apariencia (opcional)" aria-label="Detalles Extra Apariencia"></textarea>
        </div>

        <div class="gc" style="padding:24px">
          <div class="sec-title"><i class="fas fa-bolt"></i> HABILIDADES Y HABILIDADES ÚNICAS</div>
          <p class="note-text" style="margin-bottom:14px">Agrega habilidades del lore S9U. Puedes usar presets
            o escribir las tuyas. (Se incluyen en exportación y Helios).</p>
          <div style="display:flex;flex-wrap:wrap;gap:10px;margin-bottom:14px">
            <select id="habPreset" class="inp" style="flex:1;min-width:220px" aria-label="Preset de Habilidad">
              <option value="">— Preset de habilidad —</option>
            </select>
            <button onclick="addHabilidadPreset()"
              style="padding:10px 18px;background:rgba(59,130,246,.16);border:1px solid rgba(59,130,246,.25);border-radius:8px;color:#bfdbfe;font-family:'Orbitron';font-size:10px;font-weight:700;cursor:pointer;letter-spacing:1px;transition:all .25s;white-space:nowrap"><i
                class="fas fa-plus"></i> AGREGAR PRESET</button>
          </div>
          <div style="display:grid;grid-template-columns:1fr;gap:10px;margin-bottom:12px">
            <input type="text" id="habNombre" list="habSugerencias" placeholder="Nombre de habilidad" class="inp"
              aria-label="Nombre de Habilidad">
            <datalist id="habSugerencias">
              <option value="Canto del Abismo Celeste"></option>
              <option value="Sincronía de Universos"></option>
              <option value="Purificación de Aguas"></option>
              <option value="Control del Flujo Vital"></option>
              <option value="Lectura de Corrientes Temporales"></option>
              <option value="Mimetismo de Técnica"></option>
              <option value="Marca de Traslación"></option>
              <option value="Salto de Instante"></option>
              <option value="Cadenas del Velo"></option>
              <option value="Pacto Abismal"></option>
              <option value="Corona de Terror"></option>
              <option value="Umbral Inverso"></option>
            </datalist>
            <textarea id="habDesc" class="inp" style="height:90px;resize:none"
              placeholder="Descripción (qué hace, límites, coste, condición, etc.)"
              aria-label="Descripción de Habilidad"></textarea>
            <button onclick="addHabilidad()"
              style="padding:12px 18px;background:var(--primary);border:none;border-radius:8px;color:#fff;font-family:'Orbitron';font-size:10px;font-weight:800;cursor:pointer;letter-spacing:1px;transition:all .25s"><i
                class="fas fa-plus"></i> AGREGAR HABILIDAD</button>
          </div>
          <div id="habilidadesList" style="display:flex;flex-direction:column;gap:10px"></div>
        </div>

        <!-- ============================================================
     SINTONÍA ANIMAL — VÍNCULO TOTÉMICO
     - Selección de un ente (o neutro) que influye en Helios
     - Afecta el análisis local (perfiles) y el tono narrativo.
     ============================================================ -->
        <!-- SINTONÍA ANIMAL -->
        <div class="gc animal-section" style="padding:24px;border-color:rgba(167,139,250,.25)">
          <div class="animal-section__content">
            <div class="sec-title" style="color:var(--purple)"><i class="fas fa-paw"></i> SINTONÍA ANIMAL — VÍNCULO
              TOTÉMICO</div>
            <p class="note-text" style="margin-bottom:16px">Elige un animal/ente
              que acompañe al personaje como vínculo totémico (compañero, guía o sintonía espiritual). Influye en el
              análisis Helios. También puedes optar por sintonía neutra.</p>
            <div style="margin-bottom:14px">
              <div class="animal-none" id="animalNone" onclick="selectAnimal(null)">
                <span style="font-size:20px">🌀</span>
                <div>
                  <div style="font-weight:600;font-size:13px">Ningún Animal / Sintonía Neutra</div>
                  <div style="font-size:10px;opacity:.5">El personaje no posee vínculo totémico</div>
                </div>
              </div>
            </div>
            <div class="animal-grid" id="animalGrid"></div>
          </div>
          <div class="animal-section__panel" aria-live="polite">
            <div class="animal-section__panel-note">
              <p class="animal-section__panel-note-text">
                <span class="animal-section__panel-note-title">Sintonía visual</span>
                <span class="animal-section__panel-note-copy">— El animal elegido acompaña tu historia y permanece
                  visible mientras exploras esta sección.</span>
              </p>
            </div>
            <div class="animal-section__panel-img-wrap">
              <img id="animalBgImage" role="presentation" alt="Vista del animal seleccionado" />
            </div>
            <div class="animal-section__panel-desc" id="animalDesc">Selecciona un animal para mostrar su descripción.
            </div>
          </div>
        </div>

        <!-- ============================================================
     VÍNCULOS Y RELACIONES
     - Permite crear relaciones tipo (madre, rival, mentor, etc.)
     - La descripción se genera por IA (si está activa) o localmente.
     - Se exporta e influye en el análisis extendido.
     ============================================================ -->
        <!-- RELACIONES -->
        <div class="gc" style="padding:24px">
          <div class="sec-title"><i class="fas fa-users"></i> VÍNCULOS Y RELACIONES</div>
          <p class="note-text" style="margin-bottom:14px">Selecciona tipo y
            escribe nombre. La descripción se genera según los datos del personaje y su animal totémico.</p>
          <div style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:16px">
            <select id="relTipo" class="inp" style="flex:1;min-width:180px" aria-label="Tipo de Relación">
              <option value="">— Tipo de relación —</option>
            </select>
            <input type="text" id="relNombre" placeholder="Nombre de la persona" class="inp"
              style="flex:1;min-width:200px" onkeydown="if(event.key==='Enter')agregarRelacion()"
              aria-label="Nombre del Vínculo">
            <button onclick="agregarRelacion()"
              style="padding:10px 20px;background:var(--primary);border:none;border-radius:8px;color:#fff;font-family:'Orbitron';font-size:10px;font-weight:700;cursor:pointer;letter-spacing:1px;transition:all .25s;white-space:nowrap"><i
                class="fas fa-plus"></i> AGREGAR</button>
          </div>
          <div id="relaciones" style="display:flex;flex-direction:column;gap:10px"></div>
        </div>

        <!-- ============================================================
     HOBBIES Y PASATIEMPOS
     - Chips multi-selección.
     - Aporta textura narrativa y señales para Helios.
     ============================================================ -->
        <!-- HOBBIES -->
        <div class="gc" style="padding:24px">
          <div class="sec-title"><i class="fas fa-gamepad"></i> HOBBIES Y PASATIEMPOS</div>
          <div id="hobbiesGrid" style="display:flex;flex-wrap:wrap;gap:8px"></div>
          <div class="counter-badge" id="hobbiesCount" style="margin-top:12px;display:inline-block">Seleccionados: 0
          </div>
        </div>

        <!-- ============================================================
     COSAS QUE DETESTA
     - Chips con límite (1 a 8).
     - Cambia por rol (modo Villano usa DETESTA_VILLAIN).
     ============================================================ -->
        <!-- DETESTA -->
        <div class="gc" style="padding:24px">
          <div class="sec-title"><i class="fas fa-ban"></i> COSAS QUE DETESTA</div>
          <p class="note-text" style="margin-bottom:6px">Selecciona entre 1 y 8.
          </p>
          <div class="counter-badge" id="destestaCount" style="margin-bottom:14px;display:inline-block">Seleccionados: 0
            / máx 8</div>
          <div id="destestaGrid" style="display:flex;flex-wrap:wrap;gap:8px"></div>
        </div>

        <!-- ============================================================
     METAS Y DESEOS PROFUNDOS
     - Lista con checkboxes (exactamente 6).
     - En modo Villano se reemplaza por deseos villanescos.
     - Se usa en Helios, narrativa e historia.
     ============================================================ -->
        <!-- DESEOS -->
        <div class="gc" style="padding:24px">
          <div class="sec-title"><i class="fas fa-star"></i> METAS Y DESEOS PROFUNDOS</div>
          <p class="note-text" style="margin-bottom:6px">Selecciona exactamente 6
            de 10.</p>
          <div class="counter-badge" id="deseosCount" style="margin-bottom:14px;display:inline-block">Seleccionados: 0 /
            6</div>
          <div id="deseosGrid" style="display:flex;flex-direction:column;gap:10px"></div>
        </div>

        <!-- ============================================================
     RASGOS DE PERSONALIDAD
     - Chips agrupadas por categorías.
     - Se limitan a 20.
     - En modo Villano se amplía el catálogo con rasgos oscuros.
     ============================================================ -->
        <!-- RASGOS -->
        <div class="gc" style="padding:24px">
          <div class="sec-title"><i class="fas fa-check-double"></i> RASGOS DE PERSONALIDAD</div>
          <p class="note-text" style="margin-bottom:6px">Hasta 20 rasgos (60
            disponibles).</p>
          <div class="counter-badge" id="rasgosCount" style="margin-bottom:14px;display:inline-block">Seleccionados: 0 /
            máx 20</div>
          <div id="rasgosGrid" style="display:flex;flex-direction:column;gap:18px"></div>
        </div>

        <div class="gc" style="padding:24px;border-color:rgba(245,158,11,.25)">
          <div class="sec-title" style="color:var(--warn)"><i class="fas fa-tags"></i> ETIQUETAS DE HISTORIA</div>
          <p class="note-text" style="margin-bottom:6px">Selecciona exactamente 5 palabras que definan la
            historia de tu personaje.</p>
          <div class="counter-badge" id="etiquetasCount" style="margin-bottom:14px">Seleccionadas: 0 / 5</div>
          <div id="etiquetasGrid" style="display:flex;flex-wrap:wrap;gap:8px"></div>
          <div id="historiaResult"
            style="margin-top:16px;padding:12px;background:rgba(245,158,11,.08);border:1px solid rgba(245,158,11,.2);border-radius:8px;display:none">
            <div style="font-family:'Orbitron';font-size:9px;color:var(--warn);letter-spacing:1px;margin-bottom:6px">
              DEFINICIÓN DE HISTORIA <span style="opacity:.6;font-size:8px">(editable)</span></div>
            <textarea id="historiaText" class="inp" rows="3"
              style="font-size:12px;line-height:1.6;color:#fcd34d;background:rgba(0,0,0,.3);border-color:rgba(245,158,11,.25);resize:vertical"
              placeholder="La definición se generará al elegir 5 etiquetas..."></textarea>
            <div style="display:flex;gap:8px;margin-top:8px">
              <button onclick="generarHistoria()"
                style="padding:4px 10px;background:rgba(245,158,11,.15);border:1px solid rgba(245,158,11,.3);border-radius:6px;color:#fcd34d;font-family:'Share Tech Mono';font-size:10px;cursor:pointer;flex:1"><i
                  class="fas fa-sync-alt"></i> REGENERAR</button>
              <button onclick="mejorarHistoriaBreve()" id="btnMejorarHistoria"
                style="padding:4px 10px;background:var(--primary);border:none;border-radius:6px;color:#fff;font-family:'Share Tech Mono';font-size:10px;cursor:pointer;flex:1;display:none"><i
                  class="fas fa-magic"></i> MEJORAR (IA)</button>
            </div>
            <div class="history-description">
              <h3>DESCRIPCIÓN DE HISTORIA DEL PERSONAJE</h3>
              <p>Esta sección sintetiza el tono narrativo y los pilares simbólicos que alimentan el análisis Helios. Usa las 5 etiquetas como anclas conceptuales y completa el texto para que refleje el rol (héroe, villano, neutrales) y el vínculo animal elegido.</p>
              <p>Los bloques de historia se regeneran con los datos siguientes: etiquetas, apariencia destacada, habilidades clave y resultados del Test de Convergencia. Mantén el lenguaje sensorial y evita repetir frases mecánicas para que Helios produzca una conclusión rica.</p>
              <ul>
                <li>Incluye frases que expliquen cómo las etiquetas elegidas moldean su voluntad y destino.</li>
                <li>Menciona al menos una habilidad o detalle físico para anclarlo al lore.</li>
                <li>Describe en qué situaciones el vínculo totémico actúa como espejo o guía.</li>
                <li>Cuando Helios esté activo, la mejora automática refina el flujo; puedes editar el resultado final.</li>
              </ul>
            </div>
          </div>
        </div>

        <!-- ============================================================
     PERSONALIDAD MBTI (S9U)
     - Seleccion manual o por encuesta rapida
     - Integra esencias narrativas del S9U
     - Opcional: preguntas profundas y lectura IA
     ============================================================ -->
        <div class="gc" id="mbtiSection" style="padding:24px;border-color:rgba(59,130,246,.25)">
          <div class="sec-title"><i class="fas fa-brain"></i> PERSONALIDAD MBTI - ESENCIAS S9U</div>
          <p class="mbti-sub">Define el tipo MBTI del personaje para construir una personalidad coherente, profunda y
            util en la narrativa del S9U.</p>
          <div class="mbti-toolbar">
            <button class="mbti-tab active" id="mbtiModeCardsBtn" type="button"><i class="fas fa-th-large"></i>
              SELECCION
              MANUAL</button>
            <button class="mbti-tab" id="mbtiModeQuizBtn" type="button"><i class="fas fa-list"></i> ENCUESTA
              RAPIDA</button>
            <button class="mbti-tab ghost" id="mbtiResetBtn" type="button"><i class="fas fa-sync-alt"></i>
              REINICIAR</button>
            <div class="mbti-status" id="mbtiStatus">Tipo actual: —</div>
          </div>
          <div id="mbtiCardsPanel" class="mbti-panel"></div>
          <div id="mbtiQuizPanel" class="mbti-panel" style="display:none"></div>
          <div id="mbtiResult" class="mbti-result" style="display:none"></div>

          <div class="mbti-narrative">
            <div class="mbti-narrative-title">Preguntas narrativas profundas (opcional)</div>

            <div class="mbti-narrative-item">
              <label class="mbti-label" for="mbtiNarrativeMotiv">Identidad y motivaciones</label>
              <div class="mbti-support-text">¿Qué valor guía más su forma de ser?</div>
              <div class="mbti-narrative-examples">
                <button type="button" class="mbti-example" data-field="mbtiNarrativeMotiv">Liderazgo</button>
                <button type="button" class="mbti-example" data-field="mbtiNarrativeMotiv">Compasión</button>
                <button type="button" class="mbti-example" data-field="mbtiNarrativeMotiv">Libertad</button>
                <button type="button" class="mbti-example" data-field="mbtiNarrativeMotiv">Estabilidad</button>
                <button type="button" class="mbti-example" data-field="mbtiNarrativeMotiv">Conocimiento</button>
                <button type="button" class="mbti-example" data-field="mbtiNarrativeMotiv">Creatividad</button>
                <button type="button" class="mbti-example" data-field="mbtiNarrativeMotiv">Justicia</button>
              </div>
              <textarea id="mbtiNarrativeMotiv" class="inp mbti-textarea-large" rows="3"
                placeholder="Escribe o selecciona una motivación..." aria-label="Identidad y motivaciones"></textarea>
            </div>

            <div class="mbti-narrative-item">
              <label class="mbti-label" for="mbtiNarrativeConflict">Reacción al conflicto</label>
              <div class="mbti-support-text">¿Cómo suele enfrentar los problemas o desafíos?</div>
              <div class="mbti-narrative-examples">
                <button type="button" class="mbti-example" data-field="mbtiNarrativeConflict">Estrategia</button>
                <button type="button" class="mbti-example" data-field="mbtiNarrativeConflict">Diálogo</button>
                <button type="button" class="mbti-example" data-field="mbtiNarrativeConflict">Acción directa</button>
                <button type="button" class="mbti-example" data-field="mbtiNarrativeConflict">Paciencia</button>
                <button type="button" class="mbti-example" data-field="mbtiNarrativeConflict">Análisis</button>
                <button type="button" class="mbti-example" data-field="mbtiNarrativeConflict">Evitación</button>
                <button type="button" class="mbti-example" data-field="mbtiNarrativeConflict">Mediación</button>
              </div>
              <textarea id="mbtiNarrativeConflict" class="inp mbti-textarea-large" rows="3"
                placeholder="Escribe o selecciona una reacción..." aria-label="Reacción al conflicto"></textarea>
            </div>

            <div class="mbti-narrative-item">
              <label class="mbti-label" for="mbtiNarrativeDreams">Sueños y prioridades</label>
              <div class="mbti-support-text">¿Qué impulsa su existencia dentro del universo S9U?</div>
              <div class="mbti-narrative-examples">
                <button type="button" class="mbti-example" data-field="mbtiNarrativeDreams">Proteger a otros</button>
                <button type="button" class="mbti-example" data-field="mbtiNarrativeDreams">Explorar lo
                  desconocido</button>
                <button type="button" class="mbti-example" data-field="mbtiNarrativeDreams">Alcanzar sabiduría</button>
                <button type="button" class="mbti-example" data-field="mbtiNarrativeDreams">Mantener el
                  equilibrio</button>
                <button type="button" class="mbti-example" data-field="mbtiNarrativeDreams">Lograr poder</button>
                <button type="button" class="mbti-example" data-field="mbtiNarrativeDreams">Comprender la
                  verdad</button>
              </div>
              <textarea id="mbtiNarrativeDreams" class="inp mbti-textarea-large" rows="3"
                placeholder="Escribe o selecciona un sueño..." aria-label="Sueños y prioridades"></textarea>
            </div>
            <div class="mbti-ai">
              <div class="mbti-ai-actions">
                <button class="mbti-ai-btn" id="mbtiAiBtn" type="button"><i class="fas fa-magic"></i> Generar lectura
                  MBTI</button>
                <button class="mbti-ai-btn alt" id="mbtiAiClearBtn" type="button"><i class="fas fa-eraser"></i>
                  LIMPIAR</button>
              </div>
              <div id="mbtiAiResult" class="mbti-ai-result">
                <div class="mbti-reading">
                  <div class="mbti-reading-label">Lectura MBTI narrativa</div>
                  <p class="mbti-reading-placeholder">Responde las preguntas narrativas para generar una interpretación
                    MBTI adaptada al universo S9U.</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- ============================================================
     TEST DE CONVERGENCIA (20/20)
     - Preguntas tipo “cuestionario” con progreso.
     - Cambia por rol (Villano tiene set completo propio).
     - Es un requisito para habilitar Helios (100% convergencia).
     ============================================================ -->
        <!-- TEST 20 -->
        <div class="gc" style="padding:24px;border:1px solid rgba(59,130,246,.3)">
          <div
            style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;margin-bottom:6px">
            <div class="sec-title" style="margin-bottom:0"><i class="fas fa-brain"></i> TEST DE CONVERGENCIA</div>
            <div class="counter-badge" id="testProgress">0 / 20</div>
          </div>
          <div class="prog-wrap" style="margin-bottom:18px">
            <div class="prog-bar" id="testProgressBar" style="width:0%"></div>
          </div>
          <div id="testContainer" style="display:flex;flex-direction:column;gap:16px"></div>
        </div>

        <!-- EXPRESIÓN DEL PERSONAJE -->
        <div class="gc" style="padding:24px">
          <div class="sec-title"><i class="fas fa-theater-masks"></i> EXPRESIÓN DEL PERSONAJE</div>
          <p class="note-text" style="margin-bottom:14px">Tu forma de escribir revela cómo piensa y siente tu
            personaje. El sistema se adapta a tu estilo.</p>

          <!-- ============================================================
       CHAT / EXPRESIÓN DEL PERSONAJE
       - Selector de personaje (tarjetas)
       - Escena actual + log de mensajes
       - Input de escritura y botón ENVIAR
       Nota: el sistema detecta estilo de escritura y adapta las respuestas.
       ============================================================ -->
          <!-- Selector de personaje con tarjetas visuales -->
          <div id="dialogueCharacters"
            style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;margin-bottom:20px">
          </div>

          <!-- Área de diálogo -->
          <div id="dialogueContainer" style="display:flex;flex-direction:column;gap:16px">
            <div id="dialogueScene" class="dialogue-scene">
              <i class="fas fa-comments"></i> <span>Selecciona un personaje</span>
            </div>
            <div id="msgLog" class="msg-log"
              style="min-height:200px;max-height:400px;overflow-y:auto;padding:16px;background:rgba(0,0,0,.3);border-radius:10px;border:1px solid rgba(59,130,246,.15)">
            </div>
            <div style="display:flex;gap:10px">
              <input type="text" id="dialogueInput" class="inp" placeholder="Escribe como lo haría tu personaje..."
                disabled aria-label="Entrada de Diálogo">
              <button class="btn-export dialogue-send" onclick="sendDialogue()" disabled>
                <i class="fas fa-paper-plane"></i> ENVIAR
              </button>
            </div>
          </div>
        </div>

        <style>
          /* ============================================================
   CSS (CHAT)
   - Estilos de tarjetas de personaje y variaciones por modo
   - Separado del CSS principal para aislar el módulo de diálogo
   ============================================================ */
          .character-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 16px 12px;
            background: rgba(0, 0, 0, .4);
            border: 2px solid rgba(59, 130, 246, .2);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            gap: 8px;
          }

          .character-card:hover {
            border-color: var(--primary);
            background: rgba(0, 0, 0, .6);
            transform: translateY(-2px);
            box-shadow: 0 4px 20px var(--glow);
          }

          .character-card.active {
            border-color: var(--primary);
            background: rgba(var(--primary-rgb, 59, 130, 246), 0.15);
            box-shadow: 0 0 24px var(--glow);
          }

          .character-card.locked {
            opacity: 0.5;
            cursor: not-allowed;
            filter: grayscale(100%);
          }

          .char-icon {
            font-size: 24px;
            line-height: 1;
          }

          .char-name {
            font-family: 'Orbitron', sans-serif;
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 0.5px;
            text-align: center;
            color: #e2e8f0;
          }

          body.villain-mode .char-name {
            color: #fecaca
          }

          body.hero-mode .char-name {
            color: #bae6fd
          }

          body.antihero-mode .char-name {
            color: #ddd6fe
          }

          body.villain-mode .character-card:hover {
            border-color: #ef4444;
            box-shadow: 0 4px 20px rgba(239, 68, 68, 0.35);
          }

          body.hero-mode .character-card:hover {
            border-color: #38bdf8;
            box-shadow: 0 4px 20px rgba(56, 189, 248, 0.35);
          }

          body.antihero-mode .character-card:hover {
            border-color: #a78bfa;
            box-shadow: 0 4px 20px rgba(167, 139, 250, 0.35);
          }

          .dialogue-scene {
            font-family: 'Orbitron', sans-serif;
            font-size: 12px;
            font-weight: 600;
            letter-spacing: 1px;
            color: #e2e8f0;
            padding: 12px 16px;
            background: rgba(0, 0, 0, .3);
            border-radius: 8px;
            border: 1px solid rgba(var(--primary-rgb, 59, 130, 246), 0.3);
          }

          body.villain-mode .dialogue-scene {
            border-color: rgba(239, 68, 68, .35)
          }

          body.hero-mode .dialogue-scene {
            border-color: rgba(56, 189, 248, .35)
          }

          body.antihero-mode .dialogue-scene {
            border-color: rgba(167, 139, 250, .35)
          }

          .msg-log {
            font-family: var(--body-font);
            font-size: var(--fs);
            line-height: 1.6;
          }

          .player-msg {
            background: rgba(59, 130, 246, 0.15);
            border-left: 3px solid var(--primary);
            padding: 10px 14px;
            margin: 8px 0;
            border-radius: 0 8px 8px 0;
            animation: msgSlide 0.3s ease;
          }

          .npc-msg {
            background: rgba(0, 0, 0, 0.3);
            border-left: 3px solid var(--accent);
            padding: 10px 14px;
            margin: 8px 0;
            border-radius: 0 8px 8px 0;
            animation: msgSlide 0.3s ease;
          }

          .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 10px 14px;
            margin: 8px 0;
          }

          .typing-indicator span {
            width: 8px;
            height: 8px;
            background: var(--accent);
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out;
          }

          .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
          }

          .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
          }

          @keyframes typing {

            0%,
            80%,
            100% {
              transform: scale(0.8);
              opacity: 0.5;
            }

            40% {
              transform: scale(1);
              opacity: 1;
            }
          }

          @keyframes msgSlide {
            from {
              opacity: 0;
              transform: translateX(-20px);
            }

            to {
              opacity: 1;
              transform: translateX(0);
            }
          }

          .presets {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
          }

          .preset-btn {
            background: rgba(var(--primary-rgb, 59, 130, 246), 0.2);
            border: 1px solid rgba(var(--primary-rgb, 59, 130, 246), 0.3);
            border-radius: 20px;
            padding: 6px 12px;
            color: var(--accent);
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s ease;
          }

          .preset-btn:hover {
            background: rgba(var(--primary-rgb, 59, 130, 246), 0.3);
            transform: translateY(-1px);
          }

          .preset-opt {
            display: flex;
            gap: 8px;
            align-items: center;
            padding: 8px 12px;
            background: rgba(0, 0, 0, .3);
            border-radius: 8px;
            border: 1px solid rgba(var(--primary-rgb, 59, 130, 246), 0.2);
          }

          .preset-opt span {
            flex: 1;
            min-width: 0;
            font-size: 11px;
            color: rgba(255, 255, 255, 0.8);
            outline: none;
          }

          .use-btn {
            background: var(--primary);
            border: none;
            border-radius: 6px;
            padding: 4px 10px;
            color: white;
            font-size: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
          }

          .use-btn:hover {
            background: var(--accent);
            transform: translateY(-1px);
          }

          body.villain-mode .player-msg {
            border-left-color: #ef4444;
            background: rgba(239, 68, 68, 0.15);
          }

          body.hero-mode .player-msg {
            border-left-color: #38bdf8;
            background: rgba(56, 189, 248, 0.15);
          }

          body.antihero-mode .player-msg {
            border-left-color: #a78bfa;
            background: rgba(167, 139, 250, 0.15);
          }

          /* Nuevos Estilos de Imagen */
          .char-icon.has-img {
            background-size: cover;
            background-position: center;
            border-radius: 50%;
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: transparent;
            display: block;
          }

          .a-img {
            width: 100%;
            height: 120px;
            background-size: cover;
            background-position: center;
            border-radius: 6px;
            margin-bottom: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: block;
          }
        </style>

      </div><!-- fin formCol -->

      <!-- ============================================================
     PANEL LATERAL
     - Meta de convergencia (validación)
     - Botón EJECUTAR ANÁLISIS HELIOS
     - Contenedor del resultado Helios
     - Exportación TXT/PDF
     ============================================================ -->
      <div id="sideCol" style="display:flex;flex-direction:column;gap:20px">
        <div class="gc" style="padding:20px">
          <div class="sec-title" style="font-size:11px"><i class="fas fa-check-circle"></i> META DE CONVERGENCIA</div>
          <div id="validationList" style="display:flex;flex-direction:column;gap:2px"></div>
          <div class="prog-wrap" style="margin-top:10px">
            <div class="prog-bar" id="validProgressBar" style="width:0%"></div>
          </div>
          <div style="text-align:center;margin-top:6px"><span class="counter-badge" id="validPercent">0%</span></div>
        </div>
        <button class="helios-btn" id="heliosBtn" onclick="ejecutarHelios()">
          <div class="hicon"><i class="fas fa-bolt"></i></div><span>EJECUTAR ANÁLISIS HELIOS</span>
        </button>

        <div class="gc" style="padding:20px">
          <div class="sec-title" style="font-size:11px"><i class="fas fa-feather"></i> DESCRIPCIÓN DE HISTORIA DEL
            PERSONAJE</div>
          <p class="note-text" style="margin-bottom:10px">Genera una historia base a partir de todo lo
            seleccionado (incluye el Test 20/20). Puedes editarla manualmente.</p>
          <textarea id="historiaCompletaText" class="inp" rows="7"
            style="font-size:12px;line-height:1.6;color:#e2e8f0;background:rgba(0,0,0,.35);border-color:rgba(59,130,246,.25);resize:vertical"
            placeholder="Pulsa GENERAR para crear una historia base; luego edítala aquí..."
            aria-label="Historia Completa"></textarea>
          <div style="display:flex;gap:10px;margin-top:10px;flex-wrap:wrap">
            <button class="act-btn"
              style="flex:1;background:rgba(59,130,246,.18);border:1px solid rgba(59,130,246,.25);color:#bfdbfe"
              onclick="generarHistoriaCompleta()"><i class="fas fa-magic"></i> GENERAR (IA / LOCAL)</button>
            <button class="act-btn"
              style="flex:1;background:rgba(100,116,139,.22);border:1px solid rgba(100,116,139,.25);color:#94a3b8"
              onclick="limpiarHistoriaCompleta()"><i class="fas fa-eraser"></i> LIMPIAR</button>
          </div>
        </div>

        <div class="gc" style="padding:20px">
          <div class="sec-title" style="font-size:11px"><i class="fas fa-robot"></i> ANÁLISIS PSICOLÓGICO IA HELIOS
          </div>
          <div id="analisisResult" style="font-size:12px;line-height:1.7;opacity:.6;font-style:italic">Activa el botón
            cuando alcances 100% de convergencia.</div>
        </div>
        <div class="gc" style="padding:20px">
          <div class="sec-title" style="font-size:11px"><i class="fas fa-file-export"></i> EXPORTACIÓN</div>
          <div style="display:flex;flex-direction:column;gap:10px">
            <button class="act-btn btn-export" onclick="exportTXT()"><i class="fas fa-file-alt"></i> EXPORTAR
              TXT</button>
            <button class="act-btn btn-pdf" onclick="exportPDF()"><i class="fas fa-file-pdf"></i> EXPORTAR PDF</button>
            <button class="act-btn btn-reset" onclick="resetAll()"><i class="fas fa-sync-alt"></i> REINICIAR
              HELIOS</button>
          </div>
          <div id="footer-container"></div>
          <div style="display:flex;flex-direction:column;gap:10px">
          </div>
        </div>
      </div><!-- fin sideCol -->
    </div><!-- fin mainGrid -->

  </template>
  <template id="tpl-footer">
    <div class="copyright">
      <!-- Comentario: Aviso legal y propiedad intelectual del lore S9U. -->
      <strong>Copyright © 2026 Seres Del Noveno Universo. Todos los derechos reservados.</strong>
      Es fundamental declarar que el universo narrativo, la mitología, los personajes y el trasfondo conceptual de
      "Seres del Noveno Universo" (S9U) y su Gran Lore son una obra original e intelectual de <strong>Jonathan
        Gabriel Nieto</strong>. Como único y auténtico creador, Jonathan ha concebido, desarrollado, escrito y
      editado cada fibra de esta historia. Esta obra está protegida por las leyes internacionales de propiedad
      intelectual; cualquier reproducción, distribución o transformación de este material sin el consentimiento
      expreso del autor queda estrictamente prohibida. La autenticidad de S9U reside en la visión única de su
      autor original, quien posee la titularidad exclusiva sobre este legado literario.

      <div style="margin-top: 15px; font-size: 0.85em; opacity: 0.8;">
        <a href="Politica y Uso/Copyright Seres Del Noveno Universo.html"
          style="color: inherit; text-decoration: none; margin: 0 10px;">Copyright</a> |
        <a href="Politica y Uso/Terminos de Uso.html"
          style="color: inherit; text-decoration: none; margin: 0 10px;">Términos de Uso</a> |
        <a href="Politica y Uso/Politica y privacidad.html"
          style="color: inherit; text-decoration: none; margin: 0 10px;">Política de Privacidad</a> |
        <a href="Politica y Uso/Cokiees.html" style="color: inherit; text-decoration: none; margin: 0 10px;">Política de
          Cookies</a>
      </div>
    </div>
  </template>
  <!-- TEMPLATES EMBEBIDOS END -->
  <!-- Comentario: Scripts externos y lÃ³gica principal. -->
  <!-- Scripts -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- Helios Data: Ensure this file is present in js directory. Falling back to root if needed. -->
  <script src="js/helios_data.js"></script>
  <script src="js/main.js"></script>
  <!-- Comentario: Script del modulo MBTI (archivo reservado, no borrar). -->
  <script src="js/PersonalidadMBTI.js"></script>

  <script>
    // Comentario: Carga secuencial de parciales y arranque de Helios.
    // Lógica para cargar parciales e iniciar la app
    document.addEventListener('DOMContentLoaded', () => {
      const isFile = (location.protocol === 'file:');
      const loadPartial = (url, id) => fetch(url).then(r => r.text()).then(h => document.getElementById(id).innerHTML = h);
      // Comentario: Carga desde templates embebidos (modo file:// o fallback).
      const loadFromTemplate = (tplId, id) => {
        const tpl = document.getElementById(tplId);
        const target = document.getElementById(id);
        if (!tpl || !target) return false;
        target.innerHTML = tpl.innerHTML;
        return true;
      };
      // Comentario: Fallback para evitar splash congelado si algo falla.
      const splashFallback = setTimeout(() => {
        const splash = document.getElementById('splashScreen');
        if (splash && !splash.classList.contains('hidden')) {
          splash.classList.add('hidden');
          document.body.style.overflow = 'auto';
          document.body.style.overflowX = 'hidden';
          console.warn('Splash fallback activado.');
        }
      }, 6500);

      const initApp = () => {
        // Iniciar App DESPUÉS de que los parciales estén listos
        // Envolver en try-catch para asegurar que el Splash se elimine incluso si la App falla
        try {
          if (window.initHelios) {
            window.initHelios();
          } else {
            console.error("initHelios function not found in main.js");
          }
        } catch (err) {
          console.error("CRITICAL ERROR initializing Helios:", err);
          alert("Error crítico iniciando aplicación: " + err.message);
        } finally {
          // Siempre intentar iniciar splash para desbloquear la vista
          if (window.initSplash) window.initSplash();
          clearTimeout(splashFallback);
        }
      };

      if (isFile) {
        const okNav = loadFromTemplate('tpl-nav', 'nav-container');
        const okHeader = loadFromTemplate('tpl-header', 'header-container');
        const okMain = loadFromTemplate('tpl-main', 'main-container');
        if (okMain) loadFromTemplate('tpl-footer', 'footer-container');
        const allOk = okNav && okHeader && okMain;
        if (!allOk) {
          const main = document.getElementById('main-container');
          if (main) {
            main.innerHTML = `<div class="gc" style="padding:18px">
                            <div class="sec-title"><i class="fas fa-triangle-exclamation"></i> ERROR DE CARGA</div>
                            <p style="font-size:12px;opacity:.7">No se pudieron cargar los templates embebidos. Verifica que existan en index.html.</p>
                        </div>`;
          }
          if (window.initSplash) window.initSplash();
          clearTimeout(splashFallback);
          return;
        }
        initApp();
        return;
      }

      // Cargar Nav y Header
      Promise.all([
        loadPartial('partials/nav.html', 'nav-container'),
        loadPartial('partials/header.html', 'header-container')
      ]).then(() => {
        // Cargar Main, luego Footer dentro de Main
        return loadPartial('partials/main.html', 'main-container');
      }).then(() => {
        return loadPartial('partials/footer.html', 'footer-container');
      }).then(() => {
        initApp();
      }).catch(e => {
        console.error("Error loading partials:", e);
        const okNav = loadFromTemplate('tpl-nav', 'nav-container');
        const okHeader = loadFromTemplate('tpl-header', 'header-container');
        const okMain = loadFromTemplate('tpl-main', 'main-container');
        if (okMain) loadFromTemplate('tpl-footer', 'footer-container');
        const allOk = okNav && okHeader && okMain;
        if (allOk) {
          initApp();
          return;
        }
        const main = document.getElementById('main-container');
        if (main) {
          main.innerHTML = `<div class="gc" style="padding:18px">
                        <div class="sec-title"><i class="fas fa-triangle-exclamation"></i> ERROR DE CARGA</div>
                        <p style="font-size:12px;opacity:.7">No se pudieron cargar los parciales ni los templates embebidos.</p>
                    </div>`;
        }
        if (window.initSplash) window.initSplash();
        else {
          const splash = document.getElementById('splashScreen');
          if (splash) splash.classList.add('hidden');
          document.body.style.overflow = 'auto';
          document.body.style.overflowX = 'hidden';
        }
        clearTimeout(splashFallback);
      });
    });
  </script>
</body>

</html>
